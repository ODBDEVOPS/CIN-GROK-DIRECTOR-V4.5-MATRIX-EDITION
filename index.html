<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinéGrok Director V4.5 PRO — JSON Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Rajdhani:wght@500;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #050505;
            --glass-panel: rgba(20, 20, 25, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #00f3ff;
            --accent-glow: rgba(0, 243, 255, 0.4);
            --text-main: #e0e0e0;
            --text-muted: #6e7681;
            --danger: #ff2a6d;
            --matrix: #00ff41;
        }
        body.matrix-mode {
            --bg-deep: #000; --glass-panel: rgba(0,20,0,0.6); --glass-border: rgba(0,255,65,0.2);
            --accent: var(--matrix); --accent-glow: rgba(0,255,65,0.5); --text-main: #00ff41; --text-muted: #00cc33;
        }
        /* ... (même CSS que V4.5, je le garde identique pour pas alourdir) ... */
        body { background-color: var(--bg-deep); color: var(--text-main); font-family: 'Inter', sans-serif; margin:0; height:100vh; overflow:hidden; display:flex;
            background-image: radial-gradient(circle at var(--mouse-x,50%) var(--mouse-y,50%), var(--accent-glow), transparent 40%); }
        /* (colle ici tout le CSS de la V4.5 précédente, je le saute pour brièveté) */
        .loader { position:fixed; inset:0; background:#000; color:var(--accent); display:flex; align-items:center; justify-content:center; font-size:2rem; z-index:99999; flex-direction:column; gap:20px; }
        .loader.hidden { opacity:0; pointer-events:none; transition:1s; }
    </style>
</head>
<body>

<div class="loader" id="loader">
    <div>CINÉGROK V4.5 PRO</div>
    <div style="font-size:1rem; opacity:0.7;">Chargement des matrices...</div>
</div>

<canvas id="matrix-rain"></canvas>

<aside class="sidebar">
    <div class="brand">CINÉGROK <span style="font-size:0.8rem; border:1px solid var(--accent); padding:3px 8px; border-radius:6px;">V4.5 PRO</span></div>

    <div class="control-group">
        <div class="control-header"><span class="lbl">Projet / Pack</span></div>
        <select id="project-select" onchange="app.loadProject(this.value)"></select>
        <button class="btn-neon" onclick="app.importProject()" style="margin-top:8px; font-size:0.8rem;">Importer JSON</button>
    </div>

    <!-- Le reste de la sidebar est identique à V4.5 -->
    <!-- ... (je remets juste les parties utiles) ... -->
    <div class="control-group">
        <div class="control-header"><span class="lbl">Univers / Style</span><button class="btn-add" onclick="ui.openModal('manga')">+</button></div>
        <select id="sel-manga" onchange="app.refresh()"></select>
    </div>
    <!-- etc... -->
</aside>

<!-- même layout que avant -->>

<script>
// ==================== CHARGEMENT JSON EXTERNE ====================
const DB = { mangas: [], characters: [], decors: [], cameras: [] };
const STATE = { scenes: [], activeSceneId: null, currentRaw: '', matrixMode: false };
let PROJECTS_LIST = [];

async function loadJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`404: ${url}`);
    return await res.json();
}

async function initApp() {
    try {
        // Chargement des bases
        DB.mangas     = await loadJSON('data/mangas.json');
        DB.characters = await loadJSON('data/characters.json');
        DB.decors     = await loadJSON('data/decors.json');
        DB.cameras    = await loadJSON('data/cameras.json');

        // Liste des projets disponibles
        PROJECTS_LIST = await loadJSON('data/projects/list.json');

        ui.fillSelect('sel-manga', DB.mangas);
        ui.fillSelectMultiple('sel-char', DB.characters);
        ui.fillSelect('project-select', PROJECTS_LIST.map(p => ({id: p.file, name: p.name})));

        // Charge le projet par défaut
        await app.loadProject('default.json');

        document.getElementById('loader').classList.add('hidden');
        setTimeout(() => document.getElementById('loader').remove(), 1000);

    } catch (e) {
        console.error(e);
        alert("Erreur de chargement des données. Vérifie que les fichiers JSON sont dans /data/");
    }
}

const app = {
    async loadProject(filename) {
        try {
            const project = await loadJSON('data/projects/' + filename);
            STATE.scenes = project.scenes || [];
            if (STATE.scenes.length === 0) app.addScene();
            else STATE.activeSceneId = STATE.scenes[0].id;
            app.renderScenes();
            app.refresh();
        } catch (e) { console.log("Nouveau projet vide"); app.addScene(); }
    },

    importProject() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    Object.assign(DB, data.DB || {});
                    Object.assign(STATE, data.STATE || {});
                    ui.fillSelect('sel-manga', DB.mangas);
                    ui.fillSelectMultiple('sel-char', DB.characters);
                    app.renderScenes();
                    app.refresh();
                    alert("Projet importé avec succès !");
                } catch { alert("Fichier invalide"); }
            };
            reader.readAsText(file);
        };
        input.click();
    },

    downloadProject() {
        const data = { DB, STATE };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cinegrok_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    },

    // ... tout le reste du code app (addScene, renderScenes, refresh, etc.) reste IDENTIQUE à V4.5
    // je te le remets juste épuré des parties redondantes
};

// Lancement
initApp();
</script>
</body>
</html>